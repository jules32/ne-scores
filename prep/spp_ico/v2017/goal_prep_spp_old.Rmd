---
title: 'OHIBC goal prep: Species (Biodiversity subgoal)'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(rgdal)
library(raster)
source('~/github/ohibc/src/R/common.R')  ### an OHIBC specific version of common.R

scenario <- 'v2017'
goal     <- 'spp_ico'
dir_git  <- '~/github/ohibc'
dir_goal <- file.path(dir_git, 'prep', goal, scenario)
dir_rgn  <- file.path(dir_git, 'prep/spatial')

dir_goal_anx        <- file.path(dir_M, 'git-annex/bcprep/spp_ico', scenario) 
dir_goal_global     <- file.path('~/github/ohiprep/globalprep/spp_ico', scenario)
dir_goal_anx_global <- file.path(dir_M, 'git-annex/globalprep/spp_ico', scenario)

library(provRmd); prov_setup()

source(file.path(dir_goal, 'spp_fxn.R'))

### set up proj4string options: BC Albers and WGS84
p4s_bcalb <- c('bcalb' = '+init=epsg:3005')
p4s_wgs84 <- c('wgs84' = '+init=epsg:4326')
```

# Summary: OHIBC Species Subgoal (Biodiversity)

This script prepares scores (status and trend) for species richness in 
British Columbia's coastal regions.  Spatial data from IUCN and Aquamaps is
combined with extinction risk information from IUCN and conservation rank
info based on province-level NatureServe categories.

Currently, the Species Richness sub-goal model is identical to the OHI Global 
model: a region's status is based upon an area-weighted average of species
health across each BC reporting region.

From Halpern et al (2012):

> The target for the Species sub-goal is to have all species at a risk status of Least Concern. We scaled the lower end of the biodiversity goal to be 0 when 75% species are extinct, a level comparable to the five documented mass extinctions and would constitute a catastrophic loss of biodiversity. The Status of assessed species was calculated as the area- and threat status-weighted average of the number of threatened species within each 0.5 degree grid cell.

**Mean risk status per cell:**

$$\bar{R}_{cell} = \frac{\displaystyle\sum_{species}(Risk)}{n_{spp}}$$

**Mean risk status per region:**

$$\bar{R}_{SPP} = \frac{\displaystyle\sum_{cells}(\bar{R}_{cell} * A_{cell} * pA_{cell-rgn})}{A_{rgn}}$$

**Species goal model**

$$X_{SPP} = \frac{((1 - \bar{R}_{SPP}) - 0.25)}{(1 - 0.25)} * 100%$$

where:

* $X_{SPP}$ is Species goal status
* $\bar{R}_{cell}$ is mean extinction risk for one cell
* $\bar{R}_{SPP}$ is area-weighted mean extinction risk for a region
* $A_{cell}$ is cell area
* $pA_{cell-rgn}$ is percent of cell area included in region
* *Risk* is scaled value for species extinction risk category, based on: 
    * 'LC' = 0.0, 'NT' = 0.2, 'VU' = 0.4, 'EN' = 0.6, 'CR' = 0.8, 'EX' = 1.0
* SPP trend is calculated in a similar area-weighted mean, but population trend values are assigned according to:
    * 'Decreasing' = -0.5, 'Stable' = 0.0, 'Increasing' = +0.5

-----

# Data sources

AquaMaps

* From http://www.aquamaps.org/main/home.php: "AquaMaps are computer-generated predictions of natural occurrence of marine species, based on the environmental tolerance of a given species with respect to depth, salinity, temperature, primary productivity, and its association with sea ice or coastal areas."
* Citation: Kaschner, K., J. Rius-Barile, K. Kesner-Reyes, C.Garilao, S.O. Kullander, T. Rees and R. Froese (2015). AquaMaps: Predicted range maps for aquatic species. World wide web electronic publication, www.aquamaps.org, Version 08/2015.

IUCN Red List spatial data: species range map shapefiles

* Species range map shapefiles downloaded from: http://www.iucnredlist.org/technical-documents/spatial-data
* Citation: IUCN 2016. The IUCN Red List of Threatened Species. Version 2015.3. <http://www.iucnredlist.org>. Downloaded on 9 December 2016.

IUCN Red List species index: list of all IUCN red list species, incl IUCN species ID and extinction risk category

* Extinction risk categories, past assessments, and habitat information, by species, downloaded from: http://apiv3.iucnredlist.org/
* Citation: IUCN 2016. The IUCN Red List of Threatened Species. Version 2016-3. <http://www.iucnredlist.org>. Downloaded <date of last script process>.

NatureServe/BC CDC conservation rank info from BC Species and Ecosystems Explorer: 

* BC Conservation Data Centre: http://www.env.gov.bc.ca/atrisk/toolintro.html
* NatureServe conservation status: http://explorer.natureserve.org/ranking.htm#global
* Citation: B.C. Conservation Data Centre. 2016. BC Species and Ecosystems Explorer. B.C. Ministry of Environment, Victoria B.C. Available: <http://a100.gov.bc.ca/pub/eswp/>.  Downloaded on 30 November 2016.

-----

# Methods

## Define assessment regions 

Using OHIBC region polygons, determine 0.5Â° raster cells corresponding to each region.

``` {r setup_region-to-cell_lookup}

rgn2cell_file <- file.path(dir_goal, 'spatial/rgn2cell.csv')
loiczid_rast_file <- file.path(dir_goal, 'spatial/loiczid.tif')

if(!file.exists(rgn2cell_file) | !file.exists(loiczid_rast_file)) {
  ### Read in OHIBC polygons, transform to WGS84 CRS
  rgn_lyr <- 'ohibc_rgn'
  
  message(sprintf('Reading OHIBC regions shapefile...\n  %s/%s.shp', dir_rgn, rgn_lyr))
  poly_bc_rgn <- readOGR(dsn     = path.expand(dir_rgn), 
                         layer   = rgn_lyr,
                         verbose = FALSE, 
                         stringsAsFactors = FALSE) %>%
    spTransform(p4s_wgs84)
  
  poly_bc_rgn@data <- poly_bc_rgn@data %>%
    mutate(rgn_id = as.integer(rgn_id))
  
  rgn_p4s <- proj4string(poly_bc_rgn)
  message('Region loaded: CRS = \n  ', rgn_p4s)
  
  rgn2cell_list <- spp_rgn2cell(poly_bc_rgn, reload = TRUE)
  
  write_csv(rgn2cell_list[[1]], rgn2cell_file)
  writeRaster(rgn2cell_list[[2]], loiczid_rast_file, overwrite = TRUE)
} else {
  git_prov(c(rgn2cell_file, loiczid_rast_file), filetype = 'output')
}

```


## Identify BC-specific species

``` {r identify_BC_species}

reload <- FALSE

rgn2cell_df <- read_csv(file.path(dir_goal, 'spatial/rgn2cell.csv'))

### collect AquaMaps species local to BC

am_spp_cells_file <- file.path(dir_goal, 'int/am_spp_cells.csv')

if(!file.exists(am_spp_cells_file) | reload) {
  ### Load Aquamaps species per cell table
  dir_data_am <- file.path(dir_M, 'git-annex/globalprep/_raw_data', 'aquamaps/d2015')
  spp_cell_file <- file.path(dir_data_am, 'csv/hcaf_sp_native_trunc.csv')

  am_spp_cells <- read_csv(spp_cell_file) %>%
    select(am_sid = speciesid, loiczid) ### drop probability column - use all cells!

  ### filter out to just cells in BC regions
  am_spp_cells_bc <- rgn2cell_df %>%
    left_join(am_spp_cells, by = 'loiczid')

  message(sprintf('Writing Aquamaps species per cell file to: \n  %s', am_spp_cells_file))
  write_csv(am_spp_cells_bc, am_spp_cells_file)
  
} else {
  
  git_prov(am_spp_cells_file, filetype = 'output')
  
}

iucn_spp_cells_local_file <- file.path(dir_goal, 'int/iucn_spp_cells.csv')

if(!file.exists(iucn_spp_cells_local_file) | reload) {
  
  iucn_spp_cells_global_file <- file.path(dir_goal_anx_global, 'int/iucn_spp_cells_d2016.csv')

  iucn_spp_cells <- read_csv(iucn_spp_cells_global_file)

  message('Trimming global IUCN cells list to local cells only...')
  iucn_spp_cells_bc <- rgn2cell_df %>%
    rename(prop_area_rgn = prop_area) %>%
    left_join(iucn_spp_cells %>%
                rename(prop_area_spp = prop_area),
              by = 'loiczid')

  message('Writing local IUCN cell list to ', iucn_spp_cells_local_file)
  write_csv(iucn_spp_cells_bc, iucn_spp_cells_local_file)
  
} else {
  
  git_prov(iucn_spp_cells_local_file, filetype = 'output')
  
}

```

-----

## Generate species lookup table from IUCN API

Currently this uses the global species lookup table. To see how this list is generated, check out [`~/ohiprep/globalprep/spp_ico/v2017/spp_data_prep.Rmd`](https://rawgit.com/OHI-Science/ohiprep/master/globalprep/spp_ico/v2017/spp_data_prep.html).

The global species list includes the following columns: 
am_sid, iucn_sid, map_iucn_sid, map_subpop, sciname, category, spp_group

Because we are working on a smaller region, some species with both AM and IUCN maps may not actually be present in both regional datasets.  So we must set the `spatial_source` according to:

* if the `map_iucn_sid` is in the `iucn_spp_cells` dataframe, use iucn.
* otherwise, it must be aquamaps.

``` {r create_ohibc_spp_list}

spp_bc_file <- file.path(dir_goal, 'int/spp_list_base.csv')
iucn_spp_cells_file <- file.path(dir_goal, 'int/iucn_spp_cells.csv')
am_spp_cells_file   <- file.path(dir_goal, 'int/am_spp_cells.csv')

if(!file.exists(spp_bc_file)) {
  
  iucn_spp <- read_csv(iucn_spp_cells_file) %>%
    select(iucn_sid, subpop) %>%
    distinct()
  am_spp <- read_csv(am_spp_cells_file) %>%
    select(am_sid) %>%
    filter(!is.na(am_sid)) %>%
    distinct()
  
  spp_global_file <- file.path(dir_goal_global, 'int/spp_list.csv')
  spp_info_global <- read_csv(spp_global_file)
  
  spp_info_iucn <- spp_info_global %>%
    inner_join(iucn_spp, by = c('map_iucn_sid' = 'iucn_sid', 'map_subpop' = 'subpop'))
  
  spp_info_am <- spp_info_global %>%
    inner_join(am_spp, by = 'am_sid')
  
  spp_info_ohibc <- bind_rows(spp_info_iucn, spp_info_am) %>%
    distinct() %>%
    mutate(spatial_source = ifelse(map_iucn_sid %in% spp_info_iucn$map_iucn_sid, 'iucn', 'am'))
  
  write_csv(spp_info_ohibc, spp_bc_file)
  
} else {
  
  git_prov(c(iucn_spp_cells_file, am_spp_cells_file), filetype = 'input')
  git_prov(spp_bc_file, filetype = 'output')
  
}

DT::datatable(read_csv(spp_bc_file, nogit = TRUE))

```

-----

## Append BC-specific species risk assessment codes

Data downloaded from BC Species and Ecosystems Explorer includes information on global status and provincial status for species, as assessed by NatureServe.

See [this table]('iucn_to_ns.html') for info on NatureServe codes

``` {r append_bcsee_scores, echo = TRUE}

spp_bc_file <- file.path(dir_goal, 'int/spp_list_base.csv')

spp_info <- read_csv(spp_bc_file) %>%
  mutate(sciname = str_replace(sciname, 'Clupea pallasii pallasii', 'Clupea pallasii')) %>%
  ### while this is N.E. it shows up in the ICO list.
  spp_append_bcsee() %>%
  distinct()

### These species are problematic in BC Howe Sound ICO:
# ico_spp_probs <- c('Ammodytes hexapterus', 'Ardea herodias', 'Clupea pallasii', 'Gavia immer', 'Haliaeetus leucocephalus', 'Hypomesus pretiosus')
# x <- spp_info %>% filter(sciname %in% ico_spp_probs)
### all there!

### let's clean up this file and ditch the legacy columns.  Lose the reference
### columns, and to ditch multi-listings, group by am_sid and iucn_sid; then
### take the mean category and trend across all multi-listed species.
### Multi-listings are due to multiple province-level scores for certain
### species
spp_clean <- spp_info %>%
  select(am_sid, iucn_sid, 
         sciname, spp_group, 
         map_iucn_sid, map_subpop,
         pr_score = status_pr_score,
         category,
         spatial_source) %>%
  distinct() %>%
  group_by(sciname) %>%
  mutate(pr_score = mean(pr_score, na.rm = TRUE),
         pr_score = ifelse(is.nan(pr_score), NA, pr_score)) %>%
  ungroup() %>%
  distinct()

### still a pesky doubled up species: Leatherback turtle!
spp_clean <- spp_clean %>%
  mutate(am_sid = ifelse(sciname == 'Dermochelys coriacea', 'Rep-4381', am_sid)) %>%
  filter(!(sciname == 'Dermochelys coriacea' & is.na(map_iucn_sid)))

# y <- spp_info %>%
#   filter(sciname %in% spp_info$sciname[duplicated(spp_info$sciname)])
# z <- unique(y$sciname)
# zz <- spp_clean %>% filter(sciname %in% z)
# x <- spp_clean %>% filter(sciname %in% ico_spp_probs)

write_csv(spp_clean, file.path(dir_goal, 'int/spp_list_clean.csv'))

```

-----

## Append time-series species risk assessment codes

Time series risk assessments are determined in the global SPP analysis.  In this analysis, we will prefer province-level risk assessments over IUCN time-series assessments.  We will keep all instances, including N.E. and DD species instances, because some of these may show up in the ICO analysis (e.g. _Clupea pallasii_)

``` {r complete_time_series}

spp_clean <- read_csv(file.path(dir_goal, 'int/spp_list_clean.csv'))

spp_cat_ts <- read_csv(file.path(dir_goal_global, 'int', 'spp_cat_timeseries_raw.csv')) %>%
  select(iucn_sid, year, cat_ts, cat_ts_score) %>%
  filter(iucn_sid %in% spp_clean$iucn_sid) %>%
  complete(year = full_seq(year, 1), nesting(iucn_sid)) %>%
  arrange(iucn_sid, year) %>%
  group_by(iucn_sid) %>%
  fill(cat_ts, cat_ts_score) %>%
    ### fills forward to most recent assessment year; older category valid til new assessment
  fill(cat_ts, cat_ts_score, .direction = 'up') %>% 
    ### fills back from first non-NE or DD assessment; assume early status is same as first assessment
  ungroup()

### set up a quick lookup to score the unmatched species
cat_scores <- spp_cat_ts %>%
  select(cat = cat_ts, score = cat_ts_score) %>%
  distinct() %>%
  arrange(score)
cat_scores <- cat_scores$score %>%
  setNames(cat_scores$cat)

spp_scored <- read_csv(file.path(dir_goal, 'int/spp_list_clean.csv')) %>%
  filter(!(is.na(map_iucn_sid) & is.na(am_sid))) %>%
  left_join(spp_cat_ts, by = 'iucn_sid') 
### Note: still some N.E. and DD species here... keep 'em in b/c some
### of these show up in ICO (e.g. Clupea pallasii)

### need to tidy up species from AM with no IUCN match.
### NOTE: For OHIBC, none... but leave in for reference
### * set up the years
spp_scored <- spp_scored %>%
  mutate(year = ifelse(is.na(year), list(unique(year)), year)) %>% 
  unnest(year) %>%
  filter(!is.na(year)) %>%
  mutate(assess_year  = year + 1,
         cat_ts       = ifelse(is.na(cat_ts), category, cat_ts),
         cat_ts_score = ifelse(is.na(cat_ts_score), cat_scores[cat_ts], cat_ts_score)) %>%
    ### using the lookup from above, set up the category scores
  filter(!(is.na(cat_ts_score) & is.na(pr_score) & year != max(year)))
    ### ditch any DD and NE species, except one record (most recent year)

spp_scored <- spp_scored %>% 
  mutate(cat_ts_score = ifelse(!is.na(pr_score), pr_score, cat_ts_score),
         cat_ts = ifelse(is.na(cat_ts), category, cat_ts)) %>%
  select(-category)

write_csv(spp_scored, file.path(dir_goal, 'int', 'spp_list_scored.csv'))

```

-----

### Generate cell-by-cell summary of species

For each half-degree cell, tally up the number of species present and determine a mean species risk value for the cell, for each year of interest.

* Since this averaging is done for each data set separately, we also track the species count per cell used to determine both the risk and the trend (separately, since many species with a risk value have no trend information, i.e. NA).  These counts are used to weight the values when the two are combined.
* Data-set specific idiosyncracies:
    * For AquaMaps, we select a threshold (currently 0%) to set the minimum probability of occurrence that determines species "presence."
    * For IUCN, no threshold is needed; but the shapefiles include a "presence" attribute in which a value of 5 indicates a region in which a subpopulation has become extinct.  We use this to manually reset local extinction risk to EX.
    * Note that for IUCN, we determine the proportional area when extracting polygons; currently we just consider any presence to fill the cell (similar to assuming even a low AquaMaps probability to indicate presence within the entire cell) - so proportional area is ignored in the calculations.
    
The following code chunk executes the functions that perform these tasks.  Note the optional arguments `fn_tag` and `prob_filter` that can be changed to facilitate custom runs (including different `spp_all` species info lists, different AquaMaps thresholds, and different filename tags to uniquely identify the custom run)

``` {r generate_cell_summaries_am_and_iucn}

spp_scored <- read_csv(file.path(dir_goal, 'int', 'spp_list_scored.csv')) %>%
  rename(cat_score   = cat_ts_score) %>%
  filter(!is.na(cat_score))

### read in AquaMaps species-cell file
am_spp_cells <- read_csv(file.path(dir_goal, 'int', 'am_spp_cells.csv'))

### read in IUCN species-cell file
iucn_spp_cells <- read_csv(file.path(dir_goal, 'int', 'iucn_spp_cells.csv')) %>%
    distinct()

years <- spp_scored$year %>%
  unique() %>%
  sort()

library(parallel)

am_cells_sum_list <- mclapply(years, mc.cores = 12, FUN = function(yr) {
  # yr <- min(years)
  spp_scored_year <- spp_scored %>%
    filter(year == yr)
  
  am_cells_sum_yr <- spp_am_cell_summary(spp_scored_year, am_spp_cells) %>%
    mutate(year = yr)
  # ### NOTE: keyed data.table works way faster than the old inner_join or merge.
  # ### loiczid | mean_cat_score | mean_trend_score | n_cat_species | n_trend_species | year
  # ### AM does not include subspecies or subpops: every am_sid corresponds to exactly one sciname.
})

am_cells_sum <- bind_rows(am_cells_sum_list)

write_csv(am_cells_sum, file.path(dir_goal, 'summary/spp_am_cells_summary.csv'))

iucn_cells_sum_list <- mclapply(years, mc.cores = 12, FUN = function(yr) {
  
  spp_scored_year <- spp_scored %>%
    filter(year == yr)  
  
  iucn_cells_sum_yr <- spp_iucn_cell_summary(spp_scored_year, iucn_spp_cells) %>%
    mutate(year = yr)
  ### loiczid | mean_cat_score | mean_trend_score | n_cat_species | n_trend_species | year
  ### IUCN includes subpops - one sciname corresponds to multiple iucn_sid values.
  
})

iucn_cells_sum <- bind_rows(iucn_cells_sum_list)
write_csv(iucn_cells_sum, file.path(dir_goal, 'summary/spp_iucn_cells_summary.csv'))

```

### Map of species count by cell

``` {r spp_plot_species_count_raster, fig.height = 4, fig.width = 6, fig.align = 'center', eval = FALSE}
### species presence doesn't change year to year; only the risk category
cells_spp_count <- iucn_cells_sum %>%
  filter(year == 2015) %>%
  dplyr::select(loiczid, n_cat_iucn = n_cat_species) %>%
  full_join(am_cells_sum %>%
              filter(year == 2015) %>%
              dplyr::select(loiczid, n_cat_am = n_cat_species),
            by = 'loiczid') %>%
  mutate(n_cat_am   = ifelse(is.na(n_cat_am), 0, n_cat_am),
         n_cat_iucn = ifelse(is.na(n_cat_iucn), 0, n_cat_iucn),
         n_cat      = n_cat_am + n_cat_iucn) %>%
  as.data.frame()

loiczid_rast <- raster(file.path(dir_goal, 'spatial/loiczid.tif'))

### use tmap mapping function
# spp_plot_raster(cells_spp_count, loiczid_rast, which_id = 'n_cat', 
#                 poly_rgn = poly_bc_rgn,
#                 title = 'Species count', scale_label = 'spp count', 
#                 scale_limits = c(0, max(cells_spp_count$n_cat)))

```

-----


# Calculate goal model

## Summarize mean category & trend per cell & region

In this section we perform the model calculations:

* We calculate mean extinction risk score across all species identified in each cell, based on NatureServe province-level rankings where available, and IUCN category ranks elsewhere.
    * IUCN ranks exclude subpopulation scores due to lack of spatially explicit distribution info for subpopulations.
* We calculate mean population trend across all species identified in each cell, based on IUCN population trend information.
* From raster-level summaries, we generate a region-level summary based on area-weighted average extinction risk and population trend.
* From the region-level summary of risk, we determine the SPP goal status based on the goal model equation.  SPP trend is identical to the regional average population trend score.

``` {r generate_means_per_cell}

iucn_cells_sum <- read_csv(file.path(dir_goal, 'summary/spp_iucn_cells_summary.csv'))
am_cells_sum   <- read_csv(file.path(dir_goal, 'summary/spp_am_cells_summary.csv'))
rgn2cell_df    <- read_csv(file.path(dir_goal, 'spatial/rgn2cell.csv'))

sum_by_loiczid <- spp_calc_cell_means(am_cells_sum, iucn_cells_sum)
### This returns location of dataframe with variables:
### loiczid | weighted_mean_cat | weighted_mean_trend | n_cat_species | n_trend_species
### and saves it to the summary folder.
write_csv(sum_by_loiczid, file.path(dir_goal, 'summary/spp_cell_summary_by_loiczid.csv'))


sum_by_rgn     <- spp_calc_rgn_means(sum_by_loiczid, rgn2cell_df)
### This returns a summary by region, including:
### rgn_id | year | rgn_mean_cat | mean_n_cat_spp | mean_n_trend_spp | status
### where the mean_n_cat_spp and trend_spp are area-weighted means of species
### counts for each region, where trend only counts species using time-series
### category data (trend excludes static, i.e. provincial, scores)

spp_st_tr_rgn <- calc_trends_per_rgn(sum_by_rgn,
                                     include_years = c(2000:2016),
                                     span = 10) %>%
    mutate(trend = round(trend/(mean_n_trend_spp/mean_n_cat_spp), 5),
           mean_n_cat_spp   = round(mean_n_cat_spp, 2),
           mean_n_trend_spp = round(mean_n_trend_spp, 2))

### This calculates trend based on a time-series span, normalizes by status
### in first year of trend; then manually normalizes by proportion of time-series
### species (only these count for trend calcs; provincial scores have no
### time series so the trend is weighted to account for this)

write_csv(spp_st_tr_rgn, file.path(dir_goal, 'summary/spp_rgn_summary.csv'))

```

Cell summary saved to: `r file.path(dir_goal, 'summary/cell_spp_summary_by_loiczid.csv')`

`r DT::datatable(sum_by_loiczid %>% filter(year == max(year)), caption = 'Overall cell summary (latest year)')`

Region summary saved to: `r file.path(dir_goal, 'summary/spp_rgn_summary.csv')`

`r DT::datatable(spp_st_tr_rgn %>% select(rgn_id, year, status, trend, mean_n_cat_spp, mean_n_trend_spp), caption = 'Region summary (all assessment years)')`

### Map of mean extinction risk category value by cell

*** not evaluated ***

``` {r spp_plot_cell_score_raster, fig.height = 4, fig.width = 6, fig.align = 'center', eval = FALSE}

scale_limits = c(min(sum_by_loiczid$weighted_mean_cat,  na.rm = TRUE), 
                 max(sum_by_loiczid$weighted_mean_cat,  na.rm = TRUE))


spp_plot_raster(as.data.frame(sum_by_loiczid %>% filter(year == 2015)), 
                loiczid_rast, 
                which_id = 'weighted_mean_cat', 
                poly_rgn = poly_bc_rgn,
                title = 'Mean extinction risk', scale_label = 'spp risk', 
                scale_limits = scale_limits,
                rev_scale = TRUE)

```

-----

## Create and save final output files

Status and trend layers saved to `output` folder.  

``` {r save_status_and_trend}

sum_by_rgn <- read_csv(file.path(dir_goal, 'summary/spp_rgn_summary.csv'))

spp_status <- sum_by_rgn %>%
  dplyr::select(rgn_id, score = status, year)
spp_trend  <- sum_by_rgn %>%
  dplyr::select(rgn_id, score = trend,  year)


spp_status_file <- file.path(dir_goal, 'output/spp_status.csv')
spp_trend_file  <- file.path(dir_goal, 'output/spp_trend.csv')

message('Writing SPP status and trend to:\n  ', 
        spp_status_file, '\n  ', 
        spp_trend_file)

write_csv(spp_status, spp_status_file)
write_csv(spp_trend, spp_trend_file)

```


### Plot map of status by region

The maps and tables show status based upon rankings from NatureServe (where available) and IUCN (where NatureServe is not available).  Currently no trend information is taken from NatureServe, so trend is based entirely on IUCN rankings.

``` {r spp_plot_scores_as_polygons, fig.height = 4, fig.width = 6, fig.align = 'center', eval = FALSE}

map_scores(sum_by_rgn %>%
             filter(year == 2015),
           score_vars   = c('status', 'rgn_mean_trend'),
           scale_labels = c('SPP status', 'SPP trend'),
           map_titles   = 'OHIBC Species subgoal')

```

-----

## Summarize mean category/trend within 3 nm of shore

Create final outputs for 3nm zone for resilience calculations.  In this step, rather than using full assessment regions, only the three-nautical-mile offshore zone is examined.

``` {r calc_3nm_SPP_status}

### Read in OHIBC 3nm offshore polygons, in WGS84 CRS
rgn_lyr <- 'ohibc_offshore_3nm'
poly_bc_3nm <- readOGR(dsn = path.expand(dir_rgn), layer = rgn_lyr,
                       verbose = FALSE, stringsAsFactors = FALSE) %>%
    spTransform(p4s_wgs84)

rgn2cell_3nm_df <- spp_rgn2cell(poly_bc_3nm, rgn_tag = '_3nm', reload = FALSE)[[1]]

sum_by_loiczid <- read_csv(file.path(dir_goal, 'summary/spp_cell_summary_by_loiczid.csv'))

sum_by_rgn_3nm  <- spp_calc_rgn_means(sum_by_loiczid, rgn2cell_3nm_df)

spp_status_3nm <- sum_by_rgn_3nm %>%
  dplyr::select(rgn_id, score = status, year)

write_csv(spp_status_3nm, file.path(dir_goal, 'output/spp_status_3nm.csv'))

```

3 Nautical Mile region summary saved to: `r file.path(dir_goal, 'summary/spp_rgn_summary_3nm.csv')`

`r DT::datatable(sum_by_rgn_3nm, caption = 'Region summary (all years)')`

-----

``` {r, results = 'asis'}

prov_wrapup(commit_outputs = FALSE)

```

