---
title: 'OHIBC goal prep: Iconic Species'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(rgdal)
library(raster)
source('~/github/ohibc/src/R/common.R')  ### an OHIBC specific version of common.R

scenario <- 'v2017'
goal     <- 'spp_ico'
dir_git  <- '~/github/ohibc'
dir_goal <- file.path(dir_git, 'prep', goal, scenario)
dir_rgn  <- file.path(dir_git, 'prep/spatial')

dir_goal_anx        <- file.path(dir_M, 'git-annex/bcprep', goal, scenario) 
dir_goal_anx_global <- file.path(dir_M, 'git-annex/globalprep', goal, scenario)

library(provRmd); prov_setup()

source(file.path(dir_goal, 'spp_fxn.R'))

### set up proj4string options: BC Albers and WGS84
p4s_bcalb <- c('bcalb' = '+init=epsg:3005')
p4s_wgs84 <- c('wgs84' = '+init=epsg:4326')

```

# Summary: OHIBC Iconic Species

This script prepares layers (species presence and species health) for Iconic Species subgoal in 
British Columbia's coastal regions.  Spatial data from IUCN and Aquamaps is
combined with extinction risk information from IUCN and conservation rank
info based on province-level NatureServe categories.

Iconic Species status is based upon a simple average of species
health for species found within each OHIBC region.

From Halpern et al (2012):

> The reference point is to have the risk status of all assessed species as Least Concern (i.e., a goal score = 1.0). Species that have not been assessed or labeled as data deficient are not included in the calculation.

**Mean risk status for OHIBC:**

$$\bar{R} = \frac{\displaystyle\sum_{species}(Risk)}{n_{spp}}$$

**Iconic Species goal model**

$$X_{SPP} = (1 - \bar{R}_{ICO}) * 100%$$

where:

* $X_{ICO}$ is Species goal status
* $\bar{R}$ is mean extinction risk for identified species within OHIBC (different subsets for ICO and SPP)
* *Risk* is scaled value for species extinction risk category, based on: 
    * 'LC' = 0.0, 'NT' = 0.2, 'VU' = 0.4, 'EN' = 0.6, 'CR' = 0.8, 'EX' = 1.0
* ICO trend is calculated as the linear trend of the average extinction risk categories over time.

-----

# Data sources

See goal_prep_spp.Rmd for data sources

-----

# Methods

## Define assessment region

Using OHIBC region polygon, determine 0.5Â° raster cells corresponding to the region.

``` {r setup_region-to-cell_lookup}

rgn2cell_file <- file.path(dir_goal, 'spatial/rgn2cell.csv')
loiczid_rast_file <- file.path(dir_goal, 'spatial/loiczid.tif')

if(!file.exists(rgn2cell_file) | !file.exists(loiczid_rast_file)) {
  ### Read in OHIBC polygons, in WGS84 CRS
  rgn_lyr <- 'ohibc_rgn_wgs84'
  
  message(sprintf('Reading OHIBC regions shapefile...\n  %s/%s.shp', dir_rgn, rgn_lyr))
  poly_bc_rgn <- readOGR(dsn     = path.expand(dir_rgn), 
                         layer   = rgn_lyr,
                         verbose = FALSE, 
                         stringsAsFactors = FALSE)
  
  poly_bc_rgn@data <- poly_bc_rgn@data %>%
    mutate(rgn_id = as.integer(rgn_id))
  
  rgn_p4s <- proj4string(poly_bc_rgn)
  message('Region loaded: CRS = \n  ', rgn_p4s)
  
  rgn2cell_list <- spp_rgn2cell(poly_bc_rgn, reload = TRUE)
  
  write_csv(rgn2cell_list[[1]], rgn2cell_file)
  writeRaster(rgn2cell_list[[2]], loiczid_rast_file, overwrite = TRUE)
} else {
  git_prov(c(rgn2cell_file, loiczid_rast_file), filetype = 'output')
}

```


## Identify OHIBC-specific species and info

The goal_prep_spp.Rmd script creates a time series of species info for all species present within OHIBC regions, as determined by AquaMaps and IUCN (incl. BirdLife International).

-----

## Identify OHIBC iconic species

Combining global ICO list with CORI-supplied ICO list, we come up with a master list of all iconic species within the OHIBC region.

``` {r generate_ico_list}

spp_ohibc <- read_csv(file.path(dir_goal, 'int/spp_list_clean.csv')) %>%
  select(sciname, am_sid, iucn_sid, map_iucn_sid) %>%
  distinct()
  
### This includes all species, including DD and N.E. species, found within
### OHIBC regions according to AM, IUCN, BLI.

# ico_list_gl <- read_csv(file.path(dir_goal, 'raw/ico_list_global.csv')) %>%
#   select(sciname = `Specie Scientific Name`,
#          comname = `Specie Common Name`) %>%
#   mutate(comname = tools::toTitleCase(comname)) %>%
#   inner_join(spp_ohibc, by = 'sciname') %>%
#   mutate(include = TRUE) %>%
#   distinct() %>%
#   write_csv(file.path(dir_goal, 'raw/ico_list_gl_incl.csv'))
ico_list_gl <- read_csv(file.path(dir_goal, 'raw/ico_list_gl_incl.csv')) %>%
  filter(include == TRUE) %>%
  select(-include)
### from this list, we include: 
  # ico_list_gl %>% group_by(spp_group) %>% summarize(n = n())
  #         spp_group     n
  # 1  CHONDRICHTHYES     8
  # 2  MARINE_MAMMALS    19
  # 3 REPTILES_marine     4
### may want to exclude some.  Particularly reptiles; these are
### probably from AquaMaps and don't include any subpop info from IUCN.

ico_list_cori <- read_csv(file.path(dir_goal, 'raw/ico_list_cori.csv')) %>%
  filter(!str_detect(comments, 'elimin')) %>% ### some spp tagged to not include
  mutate(comname = tools::toTitleCase(comname)) %>%
  select(sciname, comname) %>%
  filter(!is.na(sciname)) %>%
  left_join(spp_ohibc, by = 'sciname') %>%
  distinct()

### NOTE: Canada goose is on this list, but species info is not included.
### Will need to extract spatial info from IUCN separately... see ico_custom_spp_info.Rmd

ico_spp_custom <- read_csv(file.path(dir_goal, 'int/spp_custom_scored.csv')) %>%
  select(sciname, iucn_sid) %>%
  distinct()
ico_spp_custom_vec <- ico_spp_custom$iucn_sid %>%
  setNames(ico_spp_custom$sciname)

ico_list_cori <- ico_list_cori %>%
  mutate(iucn_sid = ifelse(is.na(iucn_sid), ico_spp_custom_vec[sciname], iucn_sid),
         map_iucn_sid = ifelse(is.na(map_iucn_sid), ico_spp_custom_vec[sciname], map_iucn_sid))

ico_list <- ico_list_gl %>%
  bind_rows(ico_list_cori) %>%
  filter(!is.na(sciname)) %>%
  distinct() %>%
  arrange(sciname)

write_csv(ico_list, file.path(dir_goal, 'int', 'ico_list_ohibc.csv'))

```


-----

## Gather assessment info for iconic species

For the identified species, we attach the assessment info generated in the SPP goal.  Some species have not been assessed or are data deficient.  Some species (i.e., Canada goose) are not included in SPP and so these data are created in a separate custom script.

``` {r summarize_ico}

ico_list <- read_csv(file.path(dir_goal, 'int', 'ico_list_ohibc.csv')) %>%
  select(sciname, comname, iucn_sid)
spp_scored <- read_csv(file.path(dir_goal, 'int', 'spp_list_scored.csv')) %>%
  # filter(!is.na(iucn_sid)) %>%
  bind_rows(read_csv(file.path(dir_goal, 'int', 'spp_custom_scored.csv')))

ico_info_ts <- ico_list %>%
  left_join(spp_scored, by = c('sciname', 'iucn_sid'))

### ico_list %>% filter(!sciname %in% ico_info_timeseries$sciname)
write_csv(ico_info_ts, file.path(dir_goal, 'int/ico_info_timeseries.csv'))

```

``` {r fix_the_custom_orcas}

ico_info_ts <- read_csv(file.path(dir_goal, 'int/ico_info_timeseries.csv')) 

orca_ts_raw <- ico_info_ts %>%
  filter(str_detect(sciname, 'Orcinus orca'))

orca_ts_full <- bind_rows(
  orca_ts_raw %>%
    mutate(sciname = 'Orcinus orca pop. 2',
           comname = 'Killer Whale (Northeast Pacific Offshore Population)',
           pr_score = .6,
           cat_ts_score = .6),
  orca_ts_raw %>%
    mutate(sciname = 'Orcinus orca pop. 3',
           comname = 'Killer Whale (West Coast Transient Population)',
           pr_score = .6,
           cat_ts_score = .6),
  orca_ts_raw %>%
    mutate(sciname = 'Orcinus orca pop. 5',
           comname = 'Killer Whale (Northeast Pacific Southern Resident Population)',
           pr_score = .8,
           cat_ts_score = .8),
  orca_ts_raw %>%
    mutate(sciname = 'Orcinus orca pop. 6',
           comname = 'Killer Whale (Northeast Pacific Northern Resident Population)',
           pr_score = .6,
           cat_ts_score = .6))

ico_info_ts_fixed <- ico_info_ts %>%
  filter(!str_detect(sciname, 'Orcinus orca')) %>%
  bind_rows(orca_ts_full)

write_csv(ico_info_ts_fixed, file.path(dir_goal, 'int/ico_info_ts_incl_orcas.csv'))

```

### OHIBC Iconic Species

The most recent assessment info for OHIBC Iconic Species:

`r DT::datatable(ico_info_ts %>% filter(is.na(year) | year == max(year, na.rm = TRUE)))`

***

In spatializing and summarizing, data-deficient and not-evaluated species will be dropped.  Status is based on mean risk category: 1 = LC, 0 = EX.  Trend is based on average risk trend of all species, normalized to the status, to get a rough estimate of percent change in status over five years.

``` {r spatialize_and_summarize}

ico_ts <- read_csv(file.path(dir_goal, 'int/ico_info_ts_incl_orcas.csv')) %>%
  mutate(cat_ts_score = ifelse(is.na(pr_score), cat_ts_score, pr_score)) %>%
  select(sciname, comname, iucn_sid, am_sid, 
         map_iucn_sid, map_subpop, spatial_source, 
         pr_score, cat_ts_score, year) %>%
  distinct()

am_ico_rgn <- read_csv(file.path(dir_goal, 'int/am_spp_cells_bc.csv')) %>%
  select(am_sid, rgn_id) %>%
  distinct()
iucn_ico_rgn <- read_csv(file.path(dir_goal, 'int/iucn_spp_cells_bc.csv')) %>%
  select(iucn_sid, subpop, rgn_id) %>%
  distinct()
iucn_ico_rgn_custom <- read_csv(file.path(dir_goal, 'spatial/BOTW_custom.csv')) %>%
  inner_join(read_csv(file.path(dir_goal, 'spatial/rgn2cell.csv')), by = 'loiczid') %>%
  select(iucn_sid, subpop, rgn_id) %>%
  distinct()
iucn_ico_rgn <- iucn_ico_rgn %>%
  bind_rows(iucn_ico_rgn_custom)

ico_rgn_ts <- ico_ts %>%
  filter(spatial_source == 'iucn') %>%
  left_join(iucn_ico_rgn, by = c('map_iucn_sid' = 'iucn_sid', 'map_subpop' = 'subpop')) %>%
  bind_rows(ico_ts %>%
    filter(spatial_source == 'am') %>%
    left_join(am_ico_rgn, by = c('am_sid'))) %>%
  select(rgn_id, year, sciname, comname, iucn_sid, am_sid, pr_score, cat_ts_score)

cat_list <- data.frame(cat_ts_score = c(  1.0,      .9,    .8,      .7,    .6,      .5,    .4,      .3,    .2,      .1,   0.0),
                       cat_label    = c( 'EX', 'CR/EX',  'CR', 'CR/EN',  'EN', 'EN/VU',  'VU', 'VU/NT',  'NT', 'NT/LC',  'LC'),
                       stringsAsFactors = FALSE)

ico_rgn_ts <- ico_rgn_ts %>%
  left_join(cat_list, by = 'cat_ts_score') %>%
  select(rgn_id,year,cat_ts_score,cat_label,sciname,comname,iucn_sid,am_sid,pr_score)

write_csv(ico_rgn_ts, file.path(dir_goal, 'output/ico_rgn_cat_ts.csv'))
# x <- ico_info_rgn_ts %>% select(sciname, rgn_id) %>% distinct() %>% group_by(sciname) %>% summarize(n_rgn = n())
# y <- ico_list %>% filter(!sciname %in% x$sciname)

ico_rgn_sum_ts <- ico_rgn_ts %>%
  select(rgn_id, sciname, cat_ts_score, year, pr_score) %>%
  group_by(rgn_id, year) %>%
  summarize(mean_cat   = mean(cat_ts_score, na.rm = TRUE),
            n_total    = n(),
            n_cat      = sum(!is.na(cat_ts_score)),
            n_trend    = sum(!is.na(cat_ts_score) & is.na(pr_score)),
            status     = round(1 - mean_cat, 5))

ico_rgn_st_tr_ts <- calc_trends_per_rgn(ico_rgn_sum_ts, include_years = c(2000:2016), span = 10)  %>%
    mutate(trend = round(trend/(n_trend/n_cat), 5))
  
write_csv(ico_rgn_st_tr_ts, file.path(dir_goal, 'summary/ico_rgn_summary.csv'))

```

### OHIBC Iconic Species status and trends

Status and trends by region:

`r DT::datatable(ico_rgn_st_tr_ts %>% select(rgn_id, year, status, trend, n_cat, n_trend))`

***

Plotting functions disabled...

``` {r plot_ico_by_cat, eval = FALSE}

ico_info_timeseries <- read_csv(file.path(dir_goal, 'int/ico_info_timeseries.csv'))

ico_table_info <- ico_info_timeseries %>%
  group_by(sciname) %>%
  # filter(sciname == last(sciname)) %>%
  arrange(year) %>%
  filter(year == last(year)) %>%
  ungroup() %>%
  select(am_sid, iucn_sid, year,
         sciname, comname,
         cat_score, pr_score) %>%
  distinct() %>%
  mutate(ico_health = round(1 - cat_score, 1)) %>%
  arrange(desc(cat_score), desc(comname))

### rearrange to get the NAs on top
ico_table_info <- ico_table_info %>%
  filter(is.na(ico_health)) %>%
  bind_rows(ico_table_info %>%
              filter(!is.na(ico_health))) %>%
  mutate(n_ico = 1:n())

### list status cats on the plot itself? ICO HEALTH IS INVERSE OF CATEGORY!!!!!
cat_list <- data.frame(ico_health = c(   0,      .1,    .2,      .3,    .4,      .5,    .6,      .7,    .8,      .9,   1.0),
                       cat_lab    = c('EX', 'CR/EX',  'CR', 'CR/EN',  'EN', 'EN/VU',  'VU', 'VU/NT',  'NT', 'NT/LC',  'LC'),
                       stringsAsFactors = FALSE)

ico_table_labeled <- ico_table_info %>%
  left_join(cat_list, by = 'ico_health') %>%
  group_by(ico_health) %>%
  mutate(cat_lab = ifelse(is.na(ico_health), 'NE/DD', cat_lab),
         cat_lab = ifelse(n_ico == last(n_ico), cat_lab, NA),
         ico_lab = paste0(comname, ' (', sciname, ')'),
         ico_lab = ifelse(!is.na(pr_score), ico_lab, paste0(ico_lab, '*')))

ico_plot <- ggplot(ico_table_labeled, aes(x = n_ico, y = 0.3, fill = ico_health)) +
  theme(axis.ticks = element_blank(),
        text = element_text(family = 'Helvetica', color = 'gray30', size = 8),
        plot.title = element_text(size = rel(1.25), hjust = 0, face = 'bold'),
        legend.key = element_rect(colour = NA, fill = NA),
        panel.border     = element_blank(),
        panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text  = element_blank(),
        legend.position = 'none') +
  geom_bar(stat = 'identity', width = 1, color = 'grey80', size = .25) +
  geom_text(aes(label = ico_lab, y = .35), 
            size = 2.5 * 1.8,
            color = 'grey20',
           # angle = 90, 
            hjust = 0) +
  geom_text(aes(label = cat_lab, y = 0),
            nudge_y = .02, 
            size = 2.5 * 1.5,
            color = 'black',
            # angle = 90, 
            hjust = 0) +
  scale_fill_gradient2(low = '#F27259', mid = '#FFCF5C', high = '#1F9B90', 
                       midpoint = 0.5,
                       breaks = c(0, .2, .4, .6, .8, 1.0),
                       labels = c('EX', 'CR', 'EN', 'VU', 'NT', 'LC'))+
  scale_y_continuous(limits = c(0, 3)) +
  coord_flip() +
  labs(fill = 'Species health')

ggsave(file.path(dir_goal, 'ico_plot_w_lines.png'),
       width = 6, height = 6, units = 'in', dpi = 300)
```

``` {r plot_ico_cat_legend, eval = FALSE}

cat_list <- data.frame(label_y    = c(-.2, seq(0, 1, 0.1)),
                       ico_health = c(NA,  seq(0, 1, 0.1)),
                       label      = c('Data Deficient/Not Evaluated',
                                      'Extinct', '', 
                                      'Critically Endangered', '',
                                      'Endangered', '',
                                      'Vulnerable', '',
                                      'Near Threatened', '',
                                      'Least Concern'),
                       stringsAsFactors = FALSE)


ico_legend <- ggplot(cat_list, aes(x = 0, y = label_y, fill = ico_health)) +
  theme(axis.ticks = element_blank(),
        text = element_text(family = 'Helvetica', color = 'gray30', size = 8),
        plot.title = element_text(size = rel(1.25), hjust = 0, face = 'bold'),
        legend.key = element_rect(colour = NA, fill = NA),
        panel.border     = element_blank(),
        panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text  = element_blank(),
        legend.position = 'none',
        title = element_text(size = 10)) +
  geom_point(size = 5, shape = 22, color = 'grey80') +
  geom_text(aes(label = label, x = .04), 
            size = 3.2,
            color = 'grey30',
            # angle = 90, 
            hjust = 0) +
  scale_fill_gradient2(low = '#F27259', mid = '#FFCF5C', high = '#1F9B90', 
                       midpoint = 0.5,
                       breaks = seq(0, 1, 0.1)) +
  scale_y_continuous(limits = c(-.2, 1)) +
  scale_x_continuous(limits = c(0, .5)) +
  labs(title = 'Species health')

ggsave(file.path(dir_goal, 'spp_ico_legend.png'),
       height = 2.3, width = 2.2, units = 'in', dpi = 300)
```

***

``` {r provenance, results = 'asis'}

prov_wrapup()

```
