---
title: 'OHIBC goal prep: Species (Biodiversity subgoal)'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(rgdal)
library(raster)
source('~/github/ohibc/src/R/common.R')  ### an OHIBC specific version of common.R

scenario <- 'v2017'
goal     <- 'spp_ico'
dir_git  <- '~/github/ohibc'
dir_goal <- file.path(dir_git, 'prep', goal, scenario)
dir_rgn  <- file.path(dir_git, 'prep/spatial')

dir_goal_anx        <- file.path(dir_M, 'git-annex/bcprep/spp_ico', scenario) 
dir_goal_global     <- file.path('~/github/ohiprep/globalprep/spp_ico', scenario)
dir_goal_anx_global <- file.path(dir_M, 'git-annex/globalprep/spp_ico', scenario)

library(provRmd); prov_setup()

source(file.path(dir_goal, 'spp_fxn.R'))

### set up proj4string options: BC Albers and WGS84
p4s_bcalb <- c('bcalb' = '+init=epsg:3005')
p4s_wgs84 <- c('wgs84' = '+init=epsg:4326')
```

# Summary: OHIBC Species Subgoal (Biodiversity)

This script prepares scores (status and trend) for species richness in 
British Columbia's coastal regions.  Spatial data from IUCN and Aquamaps is
combined with extinction risk information from IUCN and conservation rank
info based on province-level NatureServe categories.

Currently, the Species Richness sub-goal model is identical to the OHI Global 
model: a region's status is based upon an area-weighted average of species
health across each BC reporting region.

From Halpern et al (2012):

> The target for the Species sub-goal is to have all species at a risk status of Least Concern. We scaled the lower end of the biodiversity goal to be 0 when 75% species are extinct, a level comparable to the five documented mass extinctions and would constitute a catastrophic loss of biodiversity. The Status of assessed species was calculated as the area- and threat status-weighted average of the number of threatened species within each 0.5 degree grid cell.

For BC, our calculation will be slightly different, though the end result will be identical.

**Species area-weighted risk:**  For each species within a region, the risk score is weighted by the proportion of the species' range within the given region.  To determine the mean area-weighted risk, the area-weighted risks are summed and divided by the total number of species within the region.

$$R_{spp/rgn} = (Risk)*\frac{\displaystyle\sum_{rgn}(A_{cell} * pA_{cell/rgn})}{A_{rgn}}$$

$$\bar{R}_{spp} = \frac{\displaystyle\sum_{species}(R_{spp/rgn})}{n_{spp}}$$

**Species goal model**

$$X_{SPP} = \frac{((1 - \bar{R}_{spp}) - 0.25)}{(1 - 0.25)} * 100%$$

where:

* $X_{SPP}$ is Species goal status
* $R_{spp/rgn}$ is area-weighted extinction risk for one species within a region
* $\bar{R}_{spp}$ is area-weighted mean extinction risk for a region
* $A_{cell}$ is cell area
* $pA_{cell-rgn}$ is percent of cell area included in region
* *Risk* is scaled value for species extinction risk category, based on: 
    * 'LC' = 0.0, 'NT' = 0.2, 'VU' = 0.4, 'EN' = 0.6, 'CR' = 0.8, 'EX' = 1.0
* SPP trend is calculated by examining the linear trend of mean extinction risk category, based upon the time series of risk categories from the IUCN Red List.  This calculation is performed in functions.R.

-----

# Data sources

AquaMaps

* From http://www.aquamaps.org/main/home.php: "AquaMaps are computer-generated predictions of natural occurrence of marine species, based on the environmental tolerance of a given species with respect to depth, salinity, temperature, primary productivity, and its association with sea ice or coastal areas."
* Citation: Kaschner, K., J. Rius-Barile, K. Kesner-Reyes, C.Garilao, S.O. Kullander, T. Rees and R. Froese (2015). AquaMaps: Predicted range maps for aquatic species. World wide web electronic publication, www.aquamaps.org, Version 08/2015.

IUCN Red List spatial data: species range map shapefiles

* Species range map shapefiles downloaded from: http://www.iucnredlist.org/technical-documents/spatial-data
* Citation: IUCN 2016. The IUCN Red List of Threatened Species. Version 2015.3. <http://www.iucnredlist.org>. Downloaded on 9 December 2016.

IUCN Red List species index: list of all IUCN red list species, incl IUCN species ID and extinction risk category

* Extinction risk categories, past assessments, and habitat information, by species, downloaded from: http://apiv3.iucnredlist.org/
* Citation: IUCN 2016. The IUCN Red List of Threatened Species. Version 2016-3. <http://www.iucnredlist.org>. Downloaded <date of last script process>.

NatureServe/BC CDC conservation rank info from BC Species and Ecosystems Explorer: 

* BC Conservation Data Centre: http://www.env.gov.bc.ca/atrisk/toolintro.html
* NatureServe conservation status: http://explorer.natureserve.org/ranking.htm#global
* Citation: B.C. Conservation Data Centre. 2016. BC Species and Ecosystems Explorer. B.C. Ministry of Environment, Victoria B.C. Available: <http://a100.gov.bc.ca/pub/eswp/>.  Downloaded on 30 November 2016.

-----

# Methods

## Define assessment regions 

Using OHIBC region polygons, determine 0.5Â° raster cells corresponding to each region.

``` {r setup_region-to-cell_lookup}

rgn2cell_file <- file.path(dir_goal, 'spatial/rgn2cell.csv')
loiczid_rast_file <- file.path(dir_goal, 'spatial/loiczid.tif')

if(!file.exists(rgn2cell_file) | !file.exists(loiczid_rast_file)) {
  ### Read in OHIBC polygons, transform to WGS84 CRS
  rgn_lyr <- 'ohibc_rgn'
  
  message(sprintf('Reading OHIBC regions shapefile...\n  %s/%s.shp', dir_rgn, rgn_lyr))
  poly_bc_rgn <- readOGR(dsn     = path.expand(dir_rgn), 
                         layer   = rgn_lyr,
                         verbose = FALSE, 
                         stringsAsFactors = FALSE) %>%
    spTransform(p4s_wgs84)
  
  poly_bc_rgn@data <- poly_bc_rgn@data %>%
    mutate(rgn_id = as.integer(rgn_id))
  
  rgn_p4s <- proj4string(poly_bc_rgn)
  message('Region loaded: CRS = \n  ', rgn_p4s)
  
  rgn2cell_list <- spp_rgn2cell(poly_bc_rgn, reload = TRUE)
  
  write_csv(rgn2cell_list[[1]], rgn2cell_file)
  writeRaster(rgn2cell_list[[2]], loiczid_rast_file, overwrite = TRUE)
  
} else {
  
  git_prov(c(rgn2cell_file, loiczid_rast_file), filetype = 'output')
  
}

```


## Identify BC-specific species

* Data-set specific idiosyncracies:
    * For AquaMaps, we select a threshold (currently 0%) to set the minimum probability of occurrence that determines species "presence."
    * For IUCN, no threshold is needed; but the shapefiles include a "presence" attribute in which a value of 5 indicates a region in which a subpopulation has become extinct.  We use this to manually reset local extinction risk to EX.
    * Note that for IUCN, we determine the proportional area when extracting polygons; currently we just consider any presence to fill the cell (similar to assuming even a low AquaMaps probability to indicate presence within the entire cell) - so proportional area is ignored in the calculations.

``` {r identify_BC_species}

reload <- FALSE

rgn2cell_df <- read_csv(file.path(dir_goal, 'spatial/rgn2cell.csv')) %>%
  group_by(rgn_id) %>%
  mutate(area_tot = sum(cell_area * prop_area)) %>%
  ungroup()

### collect AquaMaps species local to BC

am_spp_cells_file <- file.path(dir_goal, 'int/am_spp_cells_bc.csv')
am_spp_rgn_file   <- file.path(dir_goal, 'int/am_spp_area_by_rgn.csv')

if(!file.exists(am_spp_rgn_file) | reload) {
  ### Load Aquamaps species per cell table
  dir_data_am <- file.path(dir_M, 'git-annex/globalprep/_raw_data', 'aquamaps/d2015')
  spp_cell_file <- file.path(dir_data_am, 'csv/hcaf_sp_native_trunc.csv')

  am_spp_cells <- read_csv(spp_cell_file) %>%
    select(am_sid = speciesid, loiczid) ### drop probability column - use all cells!

  ### filter out to just cells in BC regions, then summarize area by species ID and region
  message('Trimming AquaMaps global species list to local species only, then determining area per region...')
  am_spp_cells_bc <- rgn2cell_df %>%
    left_join(am_spp_cells, by = 'loiczid')
  
  am_spp_rgn_area <- am_spp_cells_bc %>%
    group_by(am_sid, rgn_id) %>%
    summarize(spp_area     = sum(cell_area * prop_area),
              spp_pct_area = sum(cell_area * prop_area / area_tot))

  message(sprintf('Writing Aquamaps species area per region file to: \n  %s', am_spp_rgn_file))
  write_csv(am_spp_cells_bc %>% select(-area_tot, -rgn_name), am_spp_cells_file)
  write_csv(am_spp_rgn_area, am_spp_rgn_file)
  
} else {
  
  git_prov(am_spp_rgn_file, filetype = 'output')
  
}

### collect IUCN species local to BC

iucn_spp_cells_file <- file.path(dir_goal, 'int/iucn_spp_cells_bc.csv')
iucn_spp_rgn_file <- file.path(dir_goal, 'int/iucn_spp_area_by_rgn.csv')

if(!file.exists(iucn_spp_rgn_file) | reload) {
  
  iucn_spp_cells_global_file <- file.path(dir_goal_anx_global, 'int/iucn_spp_cells_d2016.csv')

  iucn_spp_cells <- read_csv(iucn_spp_cells_global_file)

  iucn_spp_cells_bc <- rgn2cell_df %>%
    rename(prop_area_rgn = prop_area) %>%
    left_join(iucn_spp_cells %>%
                select(-prop_area),
              by = 'loiczid') %>%
    filter(presence != 5) %>%
    select(-presence) %>%
    distinct()
  
  iucn_spp_rgn_area <- iucn_spp_cells_bc %>%
    group_by(iucn_sid, rgn_id) %>%
    summarize(spp_area     = sum(cell_area * prop_area_rgn),
              spp_pct_area = sum(cell_area * prop_area_rgn / area_tot))
    

  message('Writing IUCN species area per region file to ', iucn_spp_rgn_file)
  write_csv(iucn_spp_cells_bc %>% select(-area_tot, -rgn_name), iucn_spp_cells_file)
  write_csv(iucn_spp_rgn_area, iucn_spp_rgn_file)
  
} else {
  
  git_prov(iucn_spp_rgn_file, filetype = 'output')
  
}

```

-----

## Generate species lookup table from IUCN API

Currently this uses the global species lookup table. To see how this list is generated, check out [`~/ohiprep/globalprep/spp_ico/v2017/spp_data_prep.Rmd`](https://rawgit.com/OHI-Science/ohiprep/master/globalprep/spp_ico/v2017/spp_data_prep.html).

The global species list includes the following columns: 
am_sid, iucn_sid, map_iucn_sid, map_subpop, sciname, category, spp_group

Because we are working on a smaller region, some species with both AM and IUCN maps may not actually be present in both regional datasets.  So we must set the `spatial_source` according to:

* if the `map_iucn_sid` is in the `iucn_spp_cells` dataframe, use iucn.
* otherwise, it must be aquamaps.

``` {r create_ohibc_spp_list}

spp_bc_file <- file.path(dir_goal, 'int/spp_list_base.csv')
iucn_spp_cells_file <- file.path(dir_goal, 'int/iucn_spp_cells_bc.csv')
am_spp_cells_file   <- file.path(dir_goal, 'int/am_spp_cells_bc.csv')

if(!file.exists(spp_bc_file)) {
  
  iucn_spp <- read_csv(iucn_spp_cells_file) %>%
    select(iucn_sid, subpop) %>%
    distinct()
  am_spp <- read_csv(am_spp_cells_file) %>%
    select(am_sid) %>%
    filter(!is.na(am_sid)) %>%
    distinct()
  
  spp_global_file <- file.path(dir_goal_global, 'int/spp_list.csv')
  spp_info_global <- read_csv(spp_global_file)
  
  spp_info_iucn <- spp_info_global %>%
    inner_join(iucn_spp, by = c('map_iucn_sid' = 'iucn_sid', 'map_subpop' = 'subpop'))
  
  spp_info_am <- spp_info_global %>%
    inner_join(am_spp, by = 'am_sid')
  
  spp_info_ohibc <- bind_rows(spp_info_iucn, spp_info_am) %>%
    distinct() %>%
    mutate(spatial_source = ifelse(map_iucn_sid %in% spp_info_iucn$map_iucn_sid, 'iucn', 'am'))
  
  write_csv(spp_info_ohibc, spp_bc_file)
  
} else {
  
  # git_prov(c(iucn_spp_cells_file, am_spp_cells_file), filetype = 'input')
  git_prov(spp_bc_file, filetype = 'output')

}

DT::datatable(read_csv(spp_bc_file, nogit = TRUE))

```

-----

## Append BC-specific species risk assessment codes

Data downloaded from BC Species and Ecosystems Explorer includes information on global status and provincial status for species, as assessed by NatureServe.

See [this table]('iucn_to_ns.html') for info on NatureServe codes

``` {r append_bcsee_scores, echo = TRUE}

spp_bc_file <- file.path(dir_goal, 'int/spp_list_base.csv')

spp_info <- read_csv(spp_bc_file) %>%
  mutate(sciname = str_replace(sciname, 'Clupea pallasii pallasii', 'Clupea pallasii')) %>%
  ### while this is N.E. it shows up in the ICO list.
  spp_append_bcsee() %>%
  distinct()

### These species are problematic in BC Howe Sound ICO:
# ico_spp_probs <- c('Ammodytes hexapterus', 'Ardea herodias', 'Clupea pallasii', 'Gavia immer', 'Haliaeetus leucocephalus', 'Hypomesus pretiosus')
# x <- spp_info %>% filter(sciname %in% ico_spp_probs)
### all there!

### let's clean up this file and ditch the legacy columns.  Lose the reference
### columns, and to ditch multi-listings, group by am_sid and iucn_sid; then
### take the mean category and trend across all multi-listed species.
### Multi-listings are due to multiple province-level scores for certain
### species
spp_clean <- spp_info %>%
  dplyr::select(am_sid, iucn_sid, 
         sciname, spp_group, 
         map_iucn_sid, map_subpop,
         pr_score = status_pr_score,
         category,
         spatial_source) %>%
  distinct() %>%
  group_by(sciname) %>%
  mutate(pr_score = mean(pr_score, na.rm = TRUE),
         pr_score = ifelse(is.nan(pr_score), NA, pr_score)) %>%
  ungroup() %>%
  distinct()

### still a pesky doubled up species: Leatherback turtle!
spp_clean <- spp_clean %>%
  mutate(am_sid = ifelse(sciname == 'Dermochelys coriacea', 'Rep-4381', am_sid)) %>%
  filter(!(sciname == 'Dermochelys coriacea' & is.na(map_iucn_sid)))

# y <- spp_info %>%
#   filter(sciname %in% spp_info$sciname[duplicated(spp_info$sciname)])
# z <- unique(y$sciname)
# zz <- spp_clean %>% filter(sciname %in% z)
# x <- spp_clean %>% filter(sciname %in% ico_spp_probs)

write_csv(spp_clean, file.path(dir_goal, 'int/spp_list_clean.csv'))

```

-----

## Append time-series species risk assessment codes

Time series risk assessments are determined in the global SPP analysis.  In this analysis, we will prefer province-level risk assessments over IUCN time-series assessments.  We will keep all instances, including N.E. and DD species instances, because some of these may show up in the ICO analysis (e.g. _Clupea pallasii_)

``` {r complete_time_series}

spp_clean <- read_csv(file.path(dir_goal, 'int/spp_list_clean.csv'))

spp_cat_ts <- read_csv(file.path(dir_goal_global, 'int', 'spp_cat_timeseries_raw.csv')) %>%
  select(iucn_sid, year, cat_ts, cat_ts_score) %>%
  filter(iucn_sid %in% spp_clean$iucn_sid) %>%
  complete(year = full_seq(year, 1), nesting(iucn_sid)) %>%
  arrange(iucn_sid, year) %>%
  group_by(iucn_sid) %>%
  fill(cat_ts, cat_ts_score) %>%
    ### fills forward to most recent assessment year; older category valid til new assessment
  fill(cat_ts, cat_ts_score, .direction = 'up') %>% 
    ### fills back from first non-NE or DD assessment; assume early status is same as first assessment
  ungroup()

### set up a quick lookup to score the unmatched species
cat_scores <- spp_cat_ts %>%
  select(cat = cat_ts, score = cat_ts_score) %>%
  distinct() %>%
  arrange(score)
cat_scores <- cat_scores$score %>%
  setNames(cat_scores$cat)

spp_scored <- read_csv(file.path(dir_goal, 'int/spp_list_clean.csv')) %>%
  filter(!(is.na(map_iucn_sid) & is.na(am_sid))) %>%
  left_join(spp_cat_ts, by = 'iucn_sid') 
### Note: still some N.E. and DD species here... keep 'em in b/c some
### of these show up in ICO (e.g. Clupea pallasii)

### need to tidy up species from AM with no IUCN match.
### NOTE: For OHIBC, none... but leave in for reference
### * set up the years
spp_scored <- spp_scored %>%
  mutate(year = ifelse(is.na(year), list(unique(year)), year)) %>% 
  unnest(year) %>%
  filter(!is.na(year)) %>%
  mutate(cat_ts       = ifelse(is.na(cat_ts), category, cat_ts),
         cat_ts_score = ifelse(is.na(cat_ts_score), cat_scores[cat_ts], cat_ts_score)) %>%
    ### using the lookup from above, set up the category scores
  filter(!(is.na(cat_ts_score) & is.na(pr_score) & year != max(year)))
    ### ditch any DD and NE species, except one record (most recent year)

spp_scored <- spp_scored %>% 
  mutate(cat_ts_score = ifelse(!is.na(pr_score), pr_score, cat_ts_score),
         cat_ts = ifelse(is.na(cat_ts), category, cat_ts)) %>%
  select(-category)

write_csv(spp_scored, file.path(dir_goal, 'int', 'spp_list_scored.csv'))

spp_cat_ts_clean <- spp_scored %>%
  select(am_sid, iucn_sid, sciname, year, category_score = cat_ts_score) %>%
  distinct()
write_csv(spp_cat_ts_clean, file.path(dir_goal, 'output', 'spp_cat_by_yr.csv'))

```

-----

### Generate area-weighted summary of species by ID and name

For each species in the scored list, attach the region and area values.  

``` {r generate_spp_rgn_area_lookup}

spp_source_info <- read_csv(file.path(dir_goal, 'int', 'spp_list_scored.csv')) %>%
  select(am_sid, iucn_sid, sciname, spatial_source) %>%
  distinct()

iucn_spp_rgn_area <- read_csv(file.path(dir_goal, 'int', 'iucn_spp_area_by_rgn.csv')) %>%
  mutate(spatial_source = 'iucn') %>%
  inner_join(spp_source_info)
am_spp_rgn_area   <- read_csv(file.path(dir_goal, 'int', 'am_spp_area_by_rgn.csv')) %>%
  mutate(spatial_source = 'am') %>%
  inner_join(spp_source_info)

spp_rgn_area <- iucn_spp_rgn_area %>%
  bind_rows(am_spp_rgn_area) %>%
  filter(!is.na(rgn_id))

write_csv(spp_rgn_area, file.path(dir_goal, 'output', 'spp_area_by_rgn.csv'))

```


# Estimate goal model

## Summarize mean category & trend per region

In this section we estimate the model calculations:

* We calculate area-weighted mean extinction risk score across all species identified in each region, based on NatureServe province-level rankings where available, and IUCN category ranks elsewhere.
* From the region-level summary of risk, we determine the SPP goal status based on the goal model equation.

``` {r generate_means_per_rgn}

spp_area_by_rgn <- read_csv(file.path(dir_goal, 'output', 'spp_area_by_rgn.csv'))
spp_cat_by_yr <- read_csv(file.path(dir_goal, 'output', 'spp_cat_by_yr.csv'))

spp_cat_by_rgn <- spp_area_by_rgn %>%
  inner_join(spp_cat_by_yr, by = c('iucn_sid', 'am_sid', 'sciname')) %>%
  filter(!is.na(category_score))

spp_cat_rgn_yr <- spp_cat_by_rgn %>%
  group_by(rgn_id, year) %>%
  summarize(mean_cat_score = sum(category_score * spp_pct_area) / n()) %>%
  mutate(status = (.75 - mean_cat_score) / .75)

DT::datatable(spp_cat_rgn_yr)


```


-----

## Summarize mean category/trend within 3 nm of shore

Create final outputs for 3nm zone for resilience calculations.  In this step, rather than using full assessment regions, only the three-nautical-mile offshore zone is examined.

``` {r calc_3nm_spp_areas}

### Read in OHIBC 3nm offshore polygons, in WGS84 CRS
rgn_lyr <- 'ohibc_offshore_3nm'
poly_bc_3nm <- readOGR(dsn = path.expand(dir_rgn), layer = rgn_lyr,
                       verbose = FALSE, stringsAsFactors = FALSE) %>%
    spTransform(p4s_wgs84)

rgn2cell_3nm_df <- spp_rgn2cell(poly_bc_3nm, rgn_tag = '_3nm', reload = FALSE)[[1]] %>%
  group_by(rgn_id) %>%
  mutate(area_tot = sum(cell_area * prop_area)) %>%
  ungroup()

### collect AquaMaps and IUCN species within 3 nm regions

am_spp_cells_bc <- read_csv(file.path(dir_goal, 'int/am_spp_cells_bc.csv')) %>%
  select(loiczid, am_sid) %>%
  distinct()

am_spp_cells_3nm <- rgn2cell_3nm_df %>%
  inner_join(am_spp_cells_bc, by = 'loiczid')

am_spp_3nm_area <- am_spp_cells_3nm %>%
  group_by(am_sid, rgn_id) %>%
  summarize(spp_area     = sum(cell_area * prop_area),
            spp_pct_area = sum(cell_area * prop_area / area_tot))


iucn_spp_cells_bc <- read_csv(file.path(dir_goal, 'int/iucn_spp_cells_bc.csv')) %>%
  select(loiczid, iucn_sid) %>%
  distinct()
  
iucn_spp_cells_3nm <- rgn2cell_3nm_df %>%
  inner_join(iucn_spp_cells_bc, by = 'loiczid')

iucn_spp_3nm_area <- iucn_spp_cells_3nm %>%
  group_by(iucn_sid, rgn_id) %>%
  summarize(spp_area     = sum(cell_area * prop_area),
            spp_pct_area = sum(cell_area * prop_area / area_tot))
  
### join together with species info
spp_source_info <- read_csv(file.path(dir_goal, 'int', 'spp_list_scored.csv')) %>%
  select(am_sid, iucn_sid, sciname, spatial_source) %>%
  distinct()

iucn_spp_3nm_area <- iucn_spp_3nm_area %>%
  mutate(spatial_source = 'iucn') %>%
  inner_join(spp_source_info)
am_spp_3nm_area   <- am_spp_3nm_area %>%
  mutate(spatial_source = 'am') %>%
  inner_join(spp_source_info)

spp_3nm_area <- iucn_spp_3nm_area %>%
  bind_rows(am_spp_3nm_area)

write_csv(spp_3nm_area, file.path(dir_goal, 'int', 'spp_area_by_rgn_3nm.csv'))

```


``` {r calc_status_3nm}

spp_3nm_area <- read_csv(file.path(dir_goal, 'int', 'spp_area_by_rgn_3nm.csv'))

spp_cat_by_yr <- read_csv(file.path(dir_goal, 'output', 'spp_cat_by_yr.csv'))

spp_cat_3nm <- spp_3nm_area %>%
  full_join(spp_cat_by_yr, by = c('iucn_sid', 'am_sid', 'sciname')) %>%
  filter(!is.na(category_score))

spp_cat_3nm_yr <- spp_cat_3nm %>%
  group_by(rgn_id, year) %>%
  summarize(mean_cat_score = sum(category_score * spp_pct_area) / n()) %>%
  mutate(status = (.75 - mean_cat_score) / .75)

write_csv(spp_cat_3nm_yr, file.path(dir_goal, 'output/spp_status_3nm.csv'))

DT::datatable(spp_cat_3nm_yr)

```


-----

``` {r, results = 'asis'}

prov_wrapup(commit_outputs = FALSE)

```

